# --- Written by an AI assistant ---
name: Upload to FTP

on:
  push:
    branches:
      - nekoweb

jobs:
  ftp-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: Upload via FTP with throttling
        env:
          FTP_HOST: "ftp.nekoweb.org:30000"
          FTP_USER: ${{ secrets.FTP_USERNAME }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
        run: |
          find . -type f ! -path '*/\.*' | while read file; do
            remote_path="${file#./}"
            # Skip if file exists with same size
            if lftp -u "$FTP_USER","$FTP_PASS" "$FTP_HOST" -e "cls -l --sort=name \"$remote_path\"; bye" | grep -q "$(stat -c%s "$file")"; then
              echo "Skipping $file (already exists)"
              continue
            fi
            echo "Uploading $file"
            lftp -u "$FTP_USER","$FTP_PASS" "$FTP_HOST" -e "put -O $(dirname "$remote_path") \"$file\"; bye"
            sleep 4  # ~250 uploads per 15 minutes
          done
# --- End of code written by an AI assistant ---
