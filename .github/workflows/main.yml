# --- Written by an AI assistant ---
  name: Upload to FTP

  concurrency:
    group: ftp-deploy
    cancel-in-progress: false
  
  on:
    push:
      branches:
        - nekoweb
  
  jobs:
    ftp-deploy:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout repo (with submodules)
          uses: actions/checkout@v3
          with:
            submodules: recursive
  
        - name: Install lftp
          run: sudo apt-get update && sudo apt-get install -y lftp
  
        - name: Restore previous upload cache
          uses: actions/download-artifact@v3
          with:
            name: uploadcache
          continue-on-error: true
  
        - name: Generate file hash list
          run: |
            find . -type f ! -path '*/.*' -exec md5sum {} \; | sort > current_uploadcache.txt
  
        - name: Determine changed files
          run: |
            touch uploadcache.txt  # fallback if cache is missing
            comm -23 current_uploadcache.txt uploadcache.txt | awk '{$1=""; print substr($0,2)}' > changed_files.txt
            head -n 250 changed_files.txt > to_upload.txt
  
        - name: Upload changed files via FTP (max 250)
          env:
            FTP_HOST: "ftp.nekoweb.org:30000"
            FTP_USER: ${{ secrets.FTP_USERNAME }}
            FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          shell: bash
          run: |
            count=0
            while read -r file; do
              dir=$(dirname "$file")
              echo "Uploading $file"
              lftp -u "$FTP_USER","$FTP_PASS" "$FTP_HOST" -e "
                set ftp:ssl-allow no
                mkdir -p \"$dir\"
                put -O \"$dir\" \"$file\"
                bye"
              ((++count))
              echo "Uploaded $file ($count/250)"
              sleep 4
            done < to_upload.txt
  
        - name: Save updated upload cache
          run: cp current_uploadcache.txt uploadcache.txt
  
        - name: Persist updated upload cache
          uses: actions/upload-artifact@v3
          with:
            name: uploadcache
            path: uploadcache.txt
  # --- End of code written by an AI assistant ---
  